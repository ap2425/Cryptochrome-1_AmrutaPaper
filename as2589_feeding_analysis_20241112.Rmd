---
title: "Feeding Events Analysis"
author: "Amruta Swaminathan"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

Packages:
```{r}
library(tidyverse)
library(tidyr)
library(dplyr)
library(data.table)
library(knitr)
library(rmarkdown)
library(stringr)
library(ggpubr)
library("viridis")  
library(rstatix)
```


Set working directory:
```{r}
pathToInput2 <- "/Users/as2589/Downloads/calr/Cohort3/"
setwd(pathToInput2)
```

```{r}
df <- read.csv(paste0(pathToInput2,"Cohort3_FoodA_Intake_Pattern.csv"), header=T)
View(df)
```

Here, each row is a feeding attempt. 

The `Cage` column refers to individual cages, with each cage housing a single animal.
The `Event` column simply documents the event number. This is for all mice combined.
The `StartDate` column is the date on which the current feeding event is recorded to have started.
The `StartTime` column is the time at which the current feeding event is recorded to have started.
The `EndDate` column is the date on which the current feeding event is recorded to have ended.
The `EndTime` column is the time at which the current feeding event is recorded to have ended.

The other columns are not relevant to my current analysis.

Since I am interested in how many feeding attempts happen in each hourly interval, I used the `StartTime` column as my reference (I could have also chosen the `EndTime` column so this was an arbitrary choice) and I generated the hour values. I then got rid of the minutes/seconds resolution since I didn't need that.
```{r}
df$StartHour <- str_split_fixed(df$StartTime, ':', 2)
View(df)
df2 <- df[,1:14]
df3 <- df[,76]

df <- cbind(df2, df3)
colnames(df)

colnames(df) <- c("Cage", "Event", "StartDate", "StartTime", "EndDate", "EndTime", "InterIn_min", "In_min", "In_g", "In_g_min", "InF_g_min", "Stud_t", "Prob", "Accum_g","StartHour", "StartMinSec")

ncol(df)
df <- select(df, -StartMinSec)
ncol(df)
```

I generated a new column by concatenating the `StartDate` and `Hour` column and I generated another new column by concatenating the `Animal` column with the `StartDateHour` column. This is so that I can use the `table` function later to count the number of feeding events in each unique combination of animal and starting hour.
```{r}
df$StartDateHour <- paste0(df$StartDate, " ", df$StartHour)
df$Animal_StartDateHour <- paste0(df$Cage, "_", df$StartDateHour)
```

I used the `table` function in R to count the unique points in the `Animal_StartDateHour` column and that will give us our hourly feeding frequency for each animal.
```{r}
feedingCounts <- table(df$Animal_StartDateHour)
class(feedingCounts)
View(feedingCounts)
feedingCounts <- data.frame(feedingCounts)
class(feedingCounts)

colnames(feedingCounts) <- c("Animal_StartDateHour", "feedCounts")

feedingCounts[c('Animal', 'StartDateHour')] <- str_split_fixed(feedingCounts$Animal_StartDateHour, '_', 2)

feedingCounts[c('StartDate', 'StartHour')] <- str_split_fixed(feedingCounts$StartDateHour, ' ', 2)

View(feedingCounts)
```

Next, I generate the `zt` column. This is just a shifted clock system where 6:00 a.m. corresponds to ZT value of 0 and 6:00 p.m. corresponds to ZT value of 12. This matters for my final plots but at the moment it is dispensible and can be added later as long as we retain the `StartHour` information in the data frame.
```{r}
dim(feedingCounts)

feedingCounts$zt <- c(NA)

feedingCounts$StartHour <- as.numeric(feedingCounts$StartHour)

for (x in 1:nrow(feedingCounts)) {
  if ((feedingCounts$StartHour[x]%%24) >= 6) {
    feedingCounts$zt[x] = feedingCounts$StartHour[x]%%24 - 6
  }
  else {
    feedingCounts$zt[x] = feedingCounts$StartHour[x]%%24 + 18
  }
}
```

I trimmed the `feedingCounts` dataset to remove the days for which we have incomplete data.
```{r}
View(feedingCounts)

feedingCounts_trimmed <- subset(feedingCounts, StartDate!="2024/05/10" & 
                                  StartDate!="2024/05/18" &
                                  StartDate!="2024/05/19" &
                                  StartDate!="2024/05/20" &
                                  StartDate!="2024/05/22")

dim(feedingCounts)
dim(feedingCounts_trimmed)
```

Here I used the `summarise` function to generate my average values table.
```{r}
feedingCountsSummary2 <- feedingCounts_trimmed %>%
  group_by(zt, Animal) %>%
  summarise(meanFeedCounts = mean(feedCounts))

View(feedingCountsSummary2)

feedingCountsSummary2$Animal <- as.integer(feedingCountsSummary2$Animal)
feedingCountsSummary2$Animal <- factor(feedingCountsSummary2$Animal)
View(feedingCountsSummary2)
levels(feedingCountsSummary2$Animal)

feedingCountsSummary2 <- feedingCountsSummary2[order(feedingCountsSummary2$Animal),]
View(feedingCountsSummary2)

```


Adding genotype and sex information
```{r}
feedingCountsSummary2$Genotype <- c(rep(c("mut"), each=24), 
                                    rep(c("wt"), each=48),
                                    rep(c("mut"), each=24), 
                                    rep(c("wt"), each=46),
                                    rep(c("mut"), each=24), 
                                    rep(c("wt"), each=48),
                                    rep(c("mut"), each=24), 
                                    rep(c("wt"), each=47))

# mouse #5, #6, #11

feedingCountsSummary2$Sex <- c(rep(c("male"), each=24),
                              rep(c("female"), each=24),
                              rep(c("male"), each=48),
                              rep(c("female"), each=23),
                              rep(c("male"), each=47),
                              rep(c("female"), each=24),
                              rep(c("male"), each=48),
                              rep(c("female"), each=23),
                              rep(c("male"), each=24))

feedingCountsSummary2$Group <- 
  paste0(feedingCountsSummary2$Genotype, "_", feedingCountsSummary2$Sex)

feedingCountsSummary2$Group <- factor(feedingCountsSummary2$Group,
                                     levels = c("wt_female", "mut_female",
                                                "wt_male", "mut_male"))
                                            

dim(feedingCountsSummary2)
```